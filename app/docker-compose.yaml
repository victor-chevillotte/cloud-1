version: "3.8"

services:
    db:
      image: mariadb:10.6.4-focal
      container_name: maria-db
      command: '--default-authentication-plugin=mysql_native_password'
      volumes:
        - db_data:/var/lib/mysql
      restart: always
      environment:
        - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
        - MYSQL_DATABASE=${MYSQL_DATABASE}
        - MYSQL_USER=${MYSQL_USER}
        - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      expose:
        - 3306
      ports:
        - 3306:3306
      networks:
        - wordpress

    wordpress:
        container_name: wordpress
        working_dir: /var/www/html
        image: wordpress:latest
        depends_on:
            - db
        ports:
            - 80:80
        restart: always
        environment:
            WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
            WORDPRESS_DB_HOST: ${DB_HOST}
            WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
            WORDPRESS_TABLE_PREFIX: ${WP_TABLE_PREFIX}
            WORDPRESS_DB_USER: ${MYSQL_USER}
            WORDPRESS_DEBUG: 1
        healthcheck:
          test: curl --fail http://localhost:80/ || exit 1
          interval: 10s
          timeout: 10s
          retries: 3
          start_period: 10s
        volumes:
            - wp_data:/var/www/html
        networks:
            - wordpress

    wpcli:
        container_name: wpcli
        working_dir: /var/www/html
        image: wordpress:cli

        environment:
            WORDPRESS_DB_NAME: ${MYSQL_DATABASE}
            WORDPRESS_DB_HOST: ${DB_HOST}
            WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD}
            WORDPRESS_TABLE_PREFIX: wp_
            WORDPRESS_DB_USER: ${MYSQL_USER}
        depends_on:
            wordpress:
              condition: service_healthy
            db:
              condition: service_started
        user: xfs
        entrypoint: ["wp", "--allow-root"]
        command: >
            core install --path="/var/www/html" --url=${WP_URL} --title=${WP_TITLE} --admin_user=${WP_ADMIN_USER} --admin_password=${WP_ADMIN_PASSWORD} --admin_email=${WP_ADMIN_EMAIL}
            
        volumes:
            - wp_data:/var/www/html
            - db_data:/var/lib/mysql
        networks:
            - wordpress

volumes:
    db_data:
    wp_data:

networks:
    wordpress:
